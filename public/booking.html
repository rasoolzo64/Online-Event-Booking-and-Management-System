<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Event - EventHub</title>
    <script src="/js/auth.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>
    <header>
        <div class="container header-content">
            <div class="logo">EventHub</div>
            <ul class="nav-menu">
                <li><a href="/">Home</a></li>
                <li><a href="/events.html">Events</a></li>
                <li><a href="/my-bookings.html" id="navThirdLink">My Bookings</a></li>
            </ul>
            <div class="auth-buttons" id="authButtons">
                <!-- This will be populated by JavaScript -->
            </div>
        </div>
    </header>
    
    <div class="form-container">
        <h2 class="form-title"><i class="fas fa-ticket-alt"></i> Book Your Ticket</h2>
        <div id="messageContainer"></div>

        <!-- Event Details Section -->
        <div id="eventDetails" class="event-details-card">
            <div class="event-image" id="eventImage"
                style="height: 250px; background-size: cover; background-position: center; background-color: #f8f9fa; position: relative;">
                <div class="booking-badge"
                    style="background: var(--primary); color: white; padding: 8px 15px; border-radius: 20px; position: absolute; top: 15px; right: 15px; font-weight: 600;">
                    Available</div>
            </div>
            <div style="padding: 30px;">
                <h3 id="eventTitle"
                    style="margin-bottom: 20px; color: var(--dark); font-size: 1.6rem; font-weight: 600;">Loading event
                    details...</h3>
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div class="detail-item">
                        <span
                            style="font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-alt"></i> Date & Time
                        </span>
                        <p id="eventDate" style="margin: 8px 0 0 0; color: var(--gray); font-size: 0.95rem;"></p>
                    </div>
                    <div class="detail-item">
                        <span
                            style="font-weight: 600; color: var(--secondary); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt"></i> Location
                        </span>
                        <p id="eventLocation" style="margin: 8px 0 0 0; color: var(--gray); font-size: 0.95rem;"></p>
                    </div>
                    <div class="detail-item">
                        <span
                            style="font-weight: 600; color: var(--success); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-tag"></i> Price
                        </span>
                        <p id="eventPrice" style="margin: 8px 0 0 0; color: var(--gray); font-size: 0.95rem;"></p>
                    </div>
                    <div class="detail-item">
                        <span
                            style="font-weight: 600; color: var(--warning); display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-chair"></i> Available Seats
                        </span>
                        <p id="eventSeats" style="margin: 8px 0 0 0; color: var(--gray); font-size: 0.95rem;"></p>
                    </div>
                </div>
            </div>
        </div>

        <form id="bookingForm">
            <input type="hidden" id="eventId" name="eventId">

            <!-- Attendee Information Section -->
            <div class="form-section">
                <h4><i class="fas fa-user-circle"></i> Attendee Information</h4>
                <div class="form-group">
                    <label class="form-label" for="userName">
                        <i class="fas fa-user" style="color: var(--primary);"></i> Your Full Name
                    </label>
                    <input type="text" class="form-control" id="userName" name="userName" required
                        placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="userEmail">
                        <i class="fas fa-envelope" style="color: var(--primary);"></i> Email Address
                    </label>
                    <input type="email" class="form-control" id="userEmail" name="userEmail" required
                        placeholder="Enter your email address">
                </div>
            </div>

            <!-- Ticket Selection Section -->
            <div class="form-section">
                <h4><i class="fas fa-ticket-alt"></i> Ticket Selection</h4>
                <div class="form-group">
                    <label class="form-label" for="tickets">
                        <i class="fas fa-ticket" style="color: var(--secondary);"></i> Number of Tickets
                    </label>
                    <input type="number" class="form-control" id="tickets" name="tickets" min="1" value="1"
                        required style="font-size: 1.2rem; font-weight: 600; text-align: center;">
                    <small style="color: var(--gray); margin-top: 8px; display: block;">
                        <i class="fas fa-info-circle"></i> You can book any number of available tickets
                    </small>
                </div>

                <div class="price-summary">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--dark); font-size: 1.1rem;">Total Amount</div>
                            <div style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;">Including all fees
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: var(--success);">â‚¹<span
                                    id="totalAmount">0</span></div>
                            <div style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;" id="perTicketPrice">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="booking-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check-circle" style="margin-right: 10px;"></i> Complete Booking
                </button>
                <p style="text-align: center; margin-top: 25px;">
                    <a href="/events.html"
                        style="color: var(--secondary); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-arrow-left"></i> Back to Events
                    </a>
                </p>
            </div>
        </form>
    </div>

    <div class="simple-footer">
        <p>&copy; 2025 EventHub. All rights reserved.</p>
    </div>

    <script>
        // Get event ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('eventId');

        if (!eventId) {
            window.location.href = '/events.html';
        }

        // Set the event ID in the hidden field properly
        document.getElementById('eventId').value = eventId;

        let currentEvent = null;

        // Load event details
        async function loadEventDetails() {
            try {
                console.log('Loading event details for ID:', eventId);
                const response = await fetch(`/api/events/${eventId}`);

                if (!response.ok) {
                    throw new Error(`Failed to load event: ${response.status}`);
                }

                currentEvent = await response.json();
                console.log('Event data loaded:', currentEvent);

                if (response.ok) {
                    // Check if event is approved
                    if (currentEvent.status !== 'approved') {
                        showMessage(
                            `<i class="fas fa-exclamation-triangle"></i> This event is not available for booking. It may be pending approval or has been rejected.`,
                            'error'
                        );
                        document.querySelector('button[type="submit"]').disabled = true;
                        document.querySelector('button[type="submit"]').innerHTML =
                            '<i class="fas fa-ban"></i> Event Not Available';
                        return;
                    }

                    // Update event details with better formatting
                    document.getElementById('eventTitle').textContent = currentEvent.title;
                    document.getElementById('eventDate').textContent = new Date(currentEvent.date).toLocaleString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('eventLocation').textContent = currentEvent.location;
                    document.getElementById('eventPrice').textContent = `â‚¹${currentEvent.price} per ticket`;
                    document.getElementById('eventSeats').textContent = `${currentEvent.available_seats} seats available`;

                    // Set event image
                    const eventImage = document.getElementById('eventImage');
                    eventImage.style.backgroundImage = `url('${currentEvent.image_url || getDefaultEventImage(currentEvent.title)}')`;

                    // Update ticket max based on available seats
                    const ticketsInput = document.getElementById('tickets');
                    ticketsInput.max = currentEvent.available_seats; 

                    // Show warning if limited seats
                    if (currentEvent.available_seats < 10) {
                        ticketsInput.style.borderColor = 'var(--warning)';
                        showMessage(`<i class="fas fa-exclamation-triangle"></i> Only ${currentEvent.available_seats} seats left! Book soon to secure your spot.`, 'warning');
                    }

                    calculateTotal();
                } else {
                    showMessage('<i class="fas fa-exclamation-circle"></i> Event not found', 'error');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showMessage('<i class="fas fa-exclamation-circle"></i> Error loading event details: ' + error.message, 'error');
            }
        }

        // Get appropriate default image based on event type
        function getDefaultEventImage(title) {
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('tech') || lowerTitle.includes('conference')) {
                return 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=500&h=300&fit=crop';
            } else if (lowerTitle.includes('music') || lowerTitle.includes('festival')) {
                return 'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=500&h=300&fit=crop';
            } else if (lowerTitle.includes('workshop') || lowerTitle.includes('business')) {
                return 'https://images.unsplash.com/photo-1515168833906-d2d02d7b2b14?w=500&h=300&fit=crop';
            } else if (lowerTitle.includes('art') || lowerTitle.includes('exhibition')) {
                return 'https://images.unsplash.com/photo-1563089145-599997674d42?w=500&h=300&fit=crop';
            } else if (lowerTitle.includes('food') || lowerTitle.includes('wine')) {
                return 'https://images.unsplash.com/photo-1551024709-8f23befc6f87?w=500&h=300&fit=crop';
            } else {
                return 'https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?w=500&h=300&fit=crop';
            }
        }

        // Calculate total amount
        function calculateTotal() {
            const tickets = parseInt(document.getElementById('tickets').value) || 0;
            if (currentEvent && currentEvent.price) {
                const total = tickets * currentEvent.price;
                document.getElementById('totalAmount').textContent = total.toFixed(2);
                document.getElementById('perTicketPrice').textContent = `${tickets} ticket${tickets !== 1 ? 's' : ''} Ã— â‚¹${currentEvent.price}`;

                // Update button text based on ticket count
                const submitButton = document.querySelector('button[type="submit"]');
                if (tickets > 1) {
                    submitButton.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 10px;"></i> Book ${tickets} Tickets - â‚¹${total.toFixed(2)}`;
                } else {
                    submitButton.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 10px;"></i> Complete Booking - â‚¹${total.toFixed(2)}`;
                }
            }
        }

        // Booking form submission 
        document.getElementById('bookingForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Check if user is logged in
            try {
                const userResponse = await fetch('/api/user-info');
                const userInfo = await userResponse.json();
                
                if (!userInfo.loggedIn) {
                    showMessage(
                        `<i class="fas fa-exclamation-triangle"></i> Please login to book tickets. Redirecting to login page...`,
                        'error'
                    );
                    setTimeout(() => {
                        window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
                    }, 2000);
                    return;
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                showMessage('<i class="fas fa-exclamation-triangle"></i> Please login to book tickets', 'error');
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Show loading state
            submitButton.innerHTML = '<span class="loading"></span> Processing Booking...';
            submitButton.disabled = true;

            const formData = new FormData(this);
            const data = {
                eventId: eventId, 
                tickets: parseInt(formData.get('tickets')),
                userName: formData.get('userName'),
                userEmail: formData.get('userEmail')
            };

            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(
                        `<i class="fas fa-check-circle"></i> ðŸŽ‰ Booking confirmed! You've successfully booked ${data.tickets} ticket${data.tickets !== 1 ? 's' : ''} for "${result.eventTitle}". Total: â‚¹${result.totalAmount}`,
                        'success'
                    );

                    // Redirect to my-bookings page after successful booking
                    setTimeout(() => {
                        window.location.href = '/my-bookings.html';
                    }, 3000);
                } else {
                    showMessage(`<i class="fas fa-exclamation-circle"></i> ${result.error}`, 'error');
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            } catch (error) {
                console.error('Booking error:', error);
                showMessage('<i class="fas fa-exclamation-circle"></i> An error occurred during booking. Please try again.', 'error');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        document.getElementById('tickets').addEventListener('input', calculateTotal);

        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
        <div class="alert alert-${type}">
            ${message}
        </div>
    `;

            // Auto-scroll to message
            messageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Update auth buttons and navigation based on user role 
        async function updateAuthAndNavigation() {
            try {
                const response = await fetch('/api/user-info');
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }

                const userInfo = await response.json();

                const authButtons = document.getElementById('authButtons');
                const navThirdLink = document.getElementById('navThirdLink');
                const adminLink = document.getElementById('adminLink');

                if (userInfo.loggedIn) {
                    // Pre-fill user information in booking form
                    document.getElementById('userName').value = userInfo.user.name;
                    document.getElementById('userEmail').value = userInfo.user.email;
                    
                    // Update navigation based on role
                    if (userInfo.user.role === 'organizer') {
                        if (navThirdLink) {
                            navThirdLink.textContent = 'Dashboard';
                            navThirdLink.href = '/organizer-dashboard.html';
                        }
                    } else if (userInfo.user.role === 'admin') {
                        if (navThirdLink) {
                            navThirdLink.textContent = 'Admin';
                            navThirdLink.href = '/admin-dashboard.html';
                        }
                    } else {
                        if (navThirdLink) {
                            navThirdLink.textContent = 'My Bookings';
                            navThirdLink.href = '/my-bookings.html';
                        }
                    }

                    // Show admin link only for admin users
                    if (adminLink) {
                        if (userInfo.user.role === 'admin') {
                            adminLink.style.display = 'block';
                        } else {
                            adminLink.style.display = 'none';
                        }
                    }

                    // Update auth buttons
                    if (authButtons) {
                        authButtons.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span class="welcome-text">
                            <i class="fas fa-user-circle"></i> Welcome, ${userInfo.user.name}
                        </span>
                        <button class="btn btn-outline" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                `;
                    }
                } else {
                    if (navThirdLink) {
                        navThirdLink.textContent = 'My Bookings';
                        navThirdLink.href = '/my-bookings.html';
                    }
                    if (adminLink) adminLink.style.display = 'none';

                    if (authButtons) {
                        authButtons.innerHTML = `
                    <div style="display: flex; gap: 10px;">
                        <a href="/login.html?redirect=${encodeURIComponent(window.location.href)}" class="btn btn-outline">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                        <a href="/register.html" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Register
                        </a>
                    </div>
                `;
                    }
                }
            } catch (error) {
                console.error('Error checking login status:', error);
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            updateAuthAndNavigation();
            loadEventDetails();
        });
    </script>

    <style>
        @keyframes pulse {
            0% {
                border-color: var(--success);
            }

            50% {
                border-color: var(--primary);
            }

            100% {
                border-color: var(--success);
            }
        }

        .detail-item {
            transition: transform 0.3s ease;
        }

        .detail-item:hover {
            transform: translateY(-3px);
        }

        .form-section {
            transition: transform 0.2s ease;
        }

        .form-section:hover {
            transform: translateX(5px);
        }

        @media (max-width: 768px) {
            .form-container {
                margin: 20px auto;
                padding: 20px;
            }

            .event-details-card {
                margin-bottom: 20px;
            }

            .detail-item {
                margin-bottom: 10px;
            }
        }
    </style>
</body>

</html>
